{% extends "scholarship/layout.html" %}
{% load static %}

{% block body %}
{% if user.is_authenticated %}
<div class="container mt-5">

    <h2>Completed Scholarships</h2>

    {% for scholarship in scholarships %}
        {% if scholarship.recieved == None %}
            <div class="card mb-3 p-3 shadow-sm">
                <div class="scholarshipName font-weight-bold" data-id="{{ scholarship.id }}" style="cursor:pointer;">
                    {{ scholarship.scholarship }}
                </div>
                <p>Deadline: {{ scholarship.date }}</p>
                <p>Amount: <b>{{ scholarship.amount }}</b></p>

                <div class="mt-2">
                    <span>Have you received this scholarship?</span>
                    <button class="btn btn-success btn-sm yes-btn" data-id="{{ scholarship.id }}">Yes</button>
                    <button class="btn btn-danger btn-sm no-btn" data-id="{{ scholarship.id }}">No</button>
                </div>
            </div>
        {% endif %}
    {% endfor %}

    <h3>
        <button class="btn btn-outline-primary btn-sm mr-2" id="accepted-button">Accepted</button>
    </h3>
    <div id="accepted-container" style="display:none;">
        {% for scholarship in scholarships %}
            {% if scholarship.recieved == True %}
                <div class="card mb-2 p-2 shadow-sm">
                    <div class="scholarshipName font-weight-bold" data-id="{{ scholarship.id }}" style="cursor:pointer;">
                        {{ scholarship.scholarship }}
                    </div>
                    <p>Deadline: {{ scholarship.date }}</p>
                    <p>Amount: <b>{{ scholarship.amount }}</b></p>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <h3 class="mt-4">
        <button class="btn btn-outline-danger btn-sm mr-2" id="rejected-button">Rejected</button>
    </h3>
    <div id="rejected-container" style="display:none;">
        {% for scholarship in scholarships %}
            {% if scholarship.recieved == False %}
                <div class="card mb-2 p-2 shadow-sm">
                    <div class="scholarshipName font-weight-bold" data-id="{{ scholarship.id }}" style="cursor:pointer;">
                        {{ scholarship.scholarship }}
                    </div>
                    <p>Deadline: {{ scholarship.date }}</p>
                    <p>Amount: <b>{{ scholarship.amount }}</b></p>
                </div>
            {% endif %}
        {% endfor %}
    </div>

</div>
{% endif %}
{% endblock %}


{% block script %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const csrftoken = getCookie('csrftoken')

    // Toggle Accepted/Rejected sections
    const acceptedBtn = document.querySelector('#accepted-button')
    const rejectedBtn = document.querySelector('#rejected-button')
    const acceptedContainer = document.querySelector('#accepted-container')
    const rejectedContainer = document.querySelector('#rejected-container')

    acceptedBtn.onclick = () => {
        acceptedContainer.style.display = acceptedContainer.style.display === 'none' ? 'block' : 'none'
        acceptedBtn.style.transform = acceptedContainer.style.display === 'block' ? 'rotate(180deg)' : 'rotate(0deg)'
    }

    rejectedBtn.onclick = () => {
        rejectedContainer.style.display = rejectedContainer.style.display === 'none' ? 'block' : 'none'
        rejectedBtn.style.transform = rejectedContainer.style.display === 'block' ? 'rotate(180deg)' : 'rotate(0deg)'
    }

    // Scholarship click navigation
    document.querySelectorAll('.scholarshipName').forEach(elem => {
        elem.onclick = () => {
            window.location.href = `/scholarships/${elem.dataset.id}`
        }
    })

    // Yes/No buttons
    document.querySelectorAll('.yes-btn, .no-btn').forEach(btn => {
        btn.onclick = () => {
            const id = btn.dataset.id
            const received = btn.classList.contains('yes-btn')
            fetch(`/scholarships/recieved/${id}`, {
                method: 'PUT',
                headers: {'X-CSRFToken': csrftoken},
                body: JSON.stringify({ recieved: received })
            })
            .then(() => window.location.reload())
        }
    })

    function getCookie(name) {
        let cookieValue = null
        if (document.cookie && document.cookie !== '') {
            document.cookie.split(';').forEach(cookie => {
                cookie = cookie.trim()
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.slice(name.length + 1))
                }
            })
        }
        return cookieValue
    }
})
</script>
{% endblock %}
