{% extends "scholarship/layout.html" %}
{% load static %}

{% block body %}

<div class="card p-4 shadow-sm">
    <h2
        id="scholarship-id"
        data-id="{{ scholarship.id }}"
        class="mb-2"
    >
        {{ scholarship.scholarship }}
    </h2>

    <a href="{{ scholarship.url }}" target="_blank">
        {{ scholarship.url }}
    </a>

    <hr>

    <p><b>Deadline:</b> {{ scholarship.date }}</p>
    <p><b>Amount:</b> {{ scholarship.amount }}</p>
    <p><b>Requirements:</b> {{ scholarship.requirements|default:"None" }}</p>

    {% if not outdated %}
        <div class="mb-3">
            <label for="category"><b>Status:</b></label>
            <select id="category" class="form-control w-50">
                <option value="None" {% if scholarship.category == "None" %}selected{% endif %}>None</option>
                <option value="In Progress" {% if scholarship.category == "In Progress" %}selected{% endif %}>In Progress</option>
                <option value="Completed" {% if scholarship.category == "Completed" %}selected{% endif %}>Completed</option>
            </select>

            <button class="btn btn-primary mt-2" id="save-category">
                Save Status
            </button>
        </div>
    {% endif %}
</div>

<div class="card p-4 mt-4 shadow-sm">
    <h5>Document Links</h5>

    <form
        action="{% url 'adddocumentlink' scholarship.id %}"
        method="post"
        class="d-flex mb-3"
    >
        {% csrf_token %}
        <input
            name="link"
            type="url"
            class="form-control mr-2"
            placeholder="https://example.com"
            required
        >
        <button class="btn btn-outline-primary">Add</button>
    </form>

    {% for link in scholarship.documents %}
        <div class="d-flex align-items-center mb-2">
            <a href="{{ link }}" target="_blank" class="mr-3">
                {{ link }}
            </a>
            <button
                class="btn btn-sm btn-outline-danger remove-link"
                data-link="{{ link }}"
            >
                Delete
            </button>
        </div>
    {% empty %}
        <p class="text-muted">No documents added.</p>
    {% endfor %}
</div>

<div class="mt-4">
    <button class="btn btn-outline-secondary mr-2" id="edit-btn">
        Edit Scholarship
    </button>

    <button class="btn btn-outline-danger mr-2" id="delete-btn">
        Delete Scholarship
    </button>

    <a href="{% url 'index' %}" class="btn btn-link">
        ‚Üê Back to Scholarships
    </a>
</div>

{% endblock %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    const csrftoken = getCookie('csrftoken')
    const scholarshipId = document.querySelector('#scholarship-id').dataset.id

    const saveBtn = document.querySelector('#save-category')
    const deleteBtn = document.querySelector('#delete-btn')
    const editBtn = document.querySelector('#edit-btn')

    if (saveBtn) {
        saveBtn.onclick = () => {
            const category = document.querySelector('#category').value

            fetch(`/scholarships/${scholarshipId}`, {
                method: 'PUT',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ category })
            })
            .then(() => window.location.href = "{% url 'index' %}")
        }
    }

    deleteBtn.onclick = () => {
        if (!confirm("Delete this scholarship?")) return

        fetch(`/scholarships/remove/${scholarshipId}`, {
            method: 'PUT',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ delete: true })
        })
        .then(() => window.location.href = "{% url 'index' %}")
    }

    editBtn.onclick = () => {
        window.location.href = `/scholarships/edit/${scholarshipId}`
    }

    document.querySelectorAll('.remove-link').forEach(btn => {
        btn.onclick = () => {
            if (!confirm("Delete this link?")) return

            fetch(`/scholarships/${scholarshipId}/adddocumentlink`, {
                method: 'PUT',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    delete: true,
                    link: btn.dataset.link
                })
            })
            .then(() => window.location.reload())
        }
    })
})

function getCookie(name) {
    let cookieValue = null
    if (document.cookie) {
        document.cookie.split(';').forEach(cookie => {
            cookie = cookie.trim()
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1))
            }
        })
    }
    return cookieValue
}
</script>
{% endblock %}
